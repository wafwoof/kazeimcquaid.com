<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="index.css"/>
    <title>Kazei McQuaid</title>
    <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
    <link rel="manifest" href="/favicon/site.webmanifest">
    <link rel="mask-icon" href="/favicon/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#4c4c4c">
    <meta name="theme-color" content="#ffffff">
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script>
        // AFRAME computer component
        document.SCREEN_BUFFER = [];
        let placeholder_black_frame = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8/wYAAsQB8mRIF3cAAAAASUVORK5CYII==';

        AFRAME.registerComponent('virtual-computer', {
            schema: {type: 'boolean'},
            init: () => {
                // get the elements with the computer component
                const computer = document.querySelectorAll('[virtual-computer]')[0];
                // set the monitor color to bright white
                computer.addEventListener('model-loaded', () => {
                    const screen_mesh = computer.getObject3D('mesh').children[0].children[0].children[0].children[1].children[0];
                    screen_mesh.material.emissive = new THREE.Color(0.5, 0.5, 0.5);
                    const texture_loader = new THREE.TextureLoader()
                    function updateScreenTexture() {
                        // get the latest screenshot and then remove it from the buffer
                        if (document.SCREEN_BUFFER.length >= 8) {
                            document.SCREEN_BUFFER.shift();
                        }
                        let screenshot = document.SCREEN_BUFFER.shift();
                        if (screenshot === undefined) {
                            screenshot = placeholder_black_frame;
                        }
                        // create a new texture from the screenshot
                        const new_texture = texture_loader.load(screenshot);
                        new_texture.wrapS = THREE.RepeatWrapping;
                        //texture.wrapT = THREE.RepeatWrapping;       
                        new_texture.repeat.set(1.1, 1);
                        new_texture.offset.set(0.91, 0.19);
                        // make the screen reflect/emit light
                        screen_mesh.material.map = new_texture;
                        screen_mesh.material.emissiveMap = new_texture;
                    }
                    updateScreenTexture();
                    setInterval(() => {
                        updateScreenTexture();
                    }, 180);
                });
                // listen for left-control keypress to toggle wasd on/off
                let wasd_enabled = false;
                document.addEventListener('keydown', (event) => {
                    if (event.code === 'ControlLeft') {
                        if (wasd_enabled) {
                            document.querySelectorAll('[wasd-controls]')[0].removeAttribute('wasd-controls');
                            wasd_enabled = false;
                        } 
                        else if (!wasd_enabled) {
                            document.querySelectorAll('[camera]')[0].setAttribute('wasd-controls', 'acceleration: 8');
                            wasd_enabled = true;
                        }
                    }
                });
            }
        });
    </script>
</head>
<body>
    <div id="term_wrap">
        <div id="term_container"></div>
        <div id="screen_buffer_div"></div>
    </div>
    <script type="text/javascript" src="term.js"></script>
    <script type="text/javascript" src="jslinux.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dom-to-image/2.6.0/dom-to-image.min.js" integrity="sha512-01CJ9/g7e8cUmY0DFTMcUw/ikS799FHiOA0eyHsUWfOetgbx/t6oV4otQ5zXKQyIrQGTHSmRVPIgrgLcZi/WMA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script defer>
    function getScreenshot() {
        const terminal_window = document.querySelectorAll('.term')[0];
        domtoimage.toPng(terminal_window, { bgcolor: '#000000', quality: 0.9 })
        .then((dataUrl) => {
            //document.SCREEN_BUFFER = dataUrl;
            document.SCREEN_BUFFER.push(dataUrl);
        })
        .catch((error) => {
            console.error("FUNCTION getScreenshot() IN index.html IS CREATING AN ERROR", error);
        });
    }
    setInterval(() => {
        getScreenshot();
        //console.log(document.SCREEN_BUFFER.length);
    }, 100);
    </script>

    <a-scene loading-screen="dotsColor: white; backgroundColor: black" allowfullscreen="no">
        <a-entity id="camera" camera look-controls="pointerLockEnabled: true" position="0 1.3 0"></a-entity>

        <a-assets>
            <a-asset-item id="crt_monitor" src="../models/crt_monitor.glb"></a-asset-item>
        </a-assets>

        <a-entity virtual-computer="true" gltf-model="#crt_monitor" scale="1.1 1.1 1.1" position="0 1.25 -0.75"></a-entity>
        <a-box position="0 0.5 -0.75" rotation="0 0 0" color="#aaaaaa"></a-box>
        <a-sky color="#aaaaaa"></a-sky>
        <a-light type="ambient" color="#888"></a-light>
    </a-scene>
</body>
</html>