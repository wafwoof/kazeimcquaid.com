<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="index.css"/>
    <title>kazeimcquaid.com</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script>
        // AFRAME computer component
        AFRAME.registerComponent('virtual-computer', {
            schema: {type: 'boolean'},
            init: () => {
                // get the elements with the computer component
                const computer = document.querySelectorAll('[virtual-computer]')[0];
                // set the monitor color to bright white
                computer.addEventListener('model-loaded', () => {
                    const screen_mesh = computer.getObject3D('mesh').children[0].children[0].children[0].children[1].children[0];
                    //console.log("screen_mesh", screen_mesh);
                    // modify the texture of the screen
                    function updateScreenTexture() {
                        if (!document.SCREEN_BUFFER) {
                            // make screen black
                            document.SCREEN_BUFFER = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8/wYAAsQB8mRIF3cAAAAASUVORK5CYII==';
                        }
                        const texture = new THREE.TextureLoader().load(document.SCREEN_BUFFER);
                        //console.log("debugging the texture", texture);
                        texture.wrapS = THREE.RepeatWrapping;
                        texture.wrapT = THREE.RepeatWrapping;
                        texture.repeat.set(1.1, 1);
                        texture.offset.set(0.91, 0.2);
                        // make the screen reflect light
                        screen_mesh.material.map = texture;
                        // make the screen emit light
                        screen_mesh.material.emissiveMap = texture;
                        screen_mesh.material.emissive = new THREE.Color(0.8, 0.8, 0.8);
                    }
                    updateScreenTexture();
                    setInterval(() => {
                        updateScreenTexture();
                    }, 200);
                });

                // listen for left-control keypress to toggle wasd on/off
                let wasd_controls = false;
                document.addEventListener('keydown', (event) => {
                    if (event.code === 'ControlLeft') {
                        if (wasd_controls) {
                            console.log("removing wasd controls")
                            document.querySelectorAll('[wasd-controls]')[0].removeAttribute('wasd-controls');
                            wasd_controls = false;
                        } 
                        else if (!wasd_controls) {
                            console.log("adding wasd controls");
                            document.querySelectorAll('[camera]')[0].setAttribute('wasd-controls', 'acceleration: 8');
                            wasd_controls = true;
                        }
                    }
                });
            }
        });
    </script>
</head>
<body>
    <div id="term_wrap">
        <div id="term_container"></div>
        <div id="screen_buffer_div"></div>
    </div>
    <script type="text/javascript" src="term.js"></script>
    <script type="text/javascript" src="jslinux.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dom-to-image/2.6.0/dom-to-image.min.js" integrity="sha512-01CJ9/g7e8cUmY0DFTMcUw/ikS799FHiOA0eyHsUWfOetgbx/t6oV4otQ5zXKQyIrQGTHSmRVPIgrgLcZi/WMA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script defer>
    function getScreenshot() {
        const terminal_window = document.querySelectorAll('.term')[0];
        domtoimage.toPng(terminal_window, { bgcolor: '#000000', quality: 0.9 })
        .then((dataUrl) => {
            document.SCREEN_BUFFER = dataUrl;
        })
        .catch((error) => {
            console.error('oops, something went wrong!', error);
        });
    }
    
    setInterval(() => {
        getScreenshot();
    }, 200);
    </script>

    <a-scene loading-screen="dotsColor: white; backgroundColor: black">
        <a-entity id="camera" camera look-controls="pointerLockEnabled: true" position="0 1.3 0"></a-entity>

        <a-assets>
            <a-asset-item id="crt_monitor" src="../models/crt_monitor.glb"></a-asset-item>
        </a-assets>

        <a-entity virtual-computer="true" gltf-model="#crt_monitor" scale="1.1 1.1 1.1" position="0 1.25 -0.75"></a-entity>
        <a-box position="0 0.5 -0.75" rotation="0 0 0" color="#aaaaaa"></a-box>
        <a-sky color="#ECECEC"></a-sky>
        <a-light type="ambient" color="#888"></a-light>
    </a-scene>
</body>
</html>